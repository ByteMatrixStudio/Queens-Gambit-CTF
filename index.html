<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queen’s Gambit CTF</title>

  <!-- Local assets (no CDN) -->
  <link rel="stylesheet" href="assets/chessground.base.min.css">
  <link rel="stylesheet" href="assets/chessground.brown.min.css">
  <link rel="stylesheet" href="assets/chessground.pieces.min.css">
  <script defer src="assets/chessground.min.js"></script>
  <script defer src="assets/chess.umd.js"></script>

  <style>
    :root{
      --bg:#0f141b; --panel:#141b24; --text:#e6edf3; --muted:#9aa7b2;
      --border:rgba(255,255,255,.10);
      --ok:rgba(71,209,140,.35);
      --okbg:rgba(71,209,140,.10);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, #172233 0%, var(--bg) 55%, #0a0f15 100%);
      color:var(--text);
      font-family:var(--sans);
    }
    .wrap{
      max-width:1100px; margin:24px auto; padding:0 16px 24px;
      display:grid; grid-template-columns:520px 1fr; gap:16px; align-items:start;
    }
    @media(max-width:980px){ .wrap{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
    }
    #board{
      width:100%;
      aspect-ratio:1/1;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.2);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{
      cursor:pointer;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:var(--text);
      padding:9px 12px;
      font-size:13px;
    }
    .muted{color:var(--muted); font-size:13px}
    .mono{font-family:var(--mono); font-size:12px; white-space:pre-wrap; word-break:break-word; color:#cfe0ee}
    .flagBox{
      display:none;
      border:1px solid var(--ok);
      background:var(--okbg);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .title{font-weight:800}
    .sub{margin-top:4px}
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:10px;">
      <div>
        <div class="title">Queen’s Gambit CTF</div>
        <div class="muted sub">Play a Queen’s Gambit setup to unlock the flag.</div>
      </div>
      <div class="row">
        <button id="newBtn">New</button>
        <button id="flipBtn">Flip</button>
        <button id="undoBtn">Undo</button>
      </div>
    </div>

    <div id="board"></div>

    <div id="flagBox" class="flagBox">
      <div class="muted" style="margin-bottom:6px;">Unlocked</div>
      <div class="mono" id="flagText"></div>
    </div>
  </div>

  <div class="card">
    <div class="muted">Hint</div>
    <div class="mono" style="margin:6px 0 12px;">
White fights for the centre with a pawn duo.
Black mirrors, then supports with e6.
Develop a knight behind the pawns.
    </div>

    <div class="muted">Moves (PGN)</div>
    <div class="mono" id="pgnText" style="margin:6px 0 12px;">(none yet)</div>

    <div class="muted">FEN</div>
    <div class="mono" id="fenText" style="margin:6px 0 12px;"></div>

    <div class="row">
      <button id="copyPgnBtn">Copy PGN</button>
      <button id="copyFenBtn">Copy FEN</button>
    </div>
  </div>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);

  // Hard fail if assets missing (better than silent nothing)
  if (typeof Chessground === "undefined") { alert("Chessground not loaded. Check /assets file names."); return; }
  if (typeof Chess === "undefined") { alert("chess.js not loaded. Check /assets/chess.umd.js."); return; }

  // === Customize these ===
  const FLAG = "flag{queens_gambit_unlocked}";
  // ======================

  const game = new Chess();
  let flipped = false;
  let unlocked = false;

  // Force QGD for the first two black moves if applicable
  // (keyed by FEN when it's black to move)
  const OPENING_BOOK = new Map([
    // after 1.d4
    ["rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR b KQkq - 0 1", "d5"],
    // after 1.d4 d5 2.c4
    ["rnbqkbnr/pppppppp/8/3p4/2PP4/8/PP2PPPP/RNBQKBNR b KQkq - 0 2", "e6"],
  ]);

  function calcDests() {
    const dests = new Map();
    for (const sq of Chess.SQUARES) {
      const ms = game.moves({ square: sq, verbose: true });
      if (ms.length) dests.set(sq, ms.map(m => m.to));
    }
    return dests;
  }

  function lastMoveSquares() {
    const hist = game.history({ verbose: true });
    if (!hist.length) return null;
    const m = hist[hist.length - 1];
    return [m.from, m.to];
  }

  function chooseFallbackMove() {
    const moves = game.moves({ verbose: true });
    if (!moves.length) return null;

    // Prefer captures
    const captures = moves.filter(m => m.flags.includes("c") || m.flags.includes("e"));
    if (captures.length) return captures[Math.floor(Math.random() * captures.length)].san;

    // Prefer checks
    const checks = moves.filter(m => m.san.includes("+") || m.san.includes("#"));
    if (checks.length) return checks[Math.floor(Math.random() * checks.length)].san;

    // Otherwise random legal
    return moves[Math.floor(Math.random() * moves.length)].san;
  }

  // Transposition-friendly “Queen’s Gambit-ish” check:
  // - White pawn on d4 and c4
  // - Black pawn on d5 and e6
  // - White has a knight developed to c3 OR f3
  function isQueensGambitSetup() {
    const b = game.board(); // 8x8, [rank8..rank1], each square is null or {type, color}

    function at(square) {
      const file = square.charCodeAt(0) - 97;     // a=0
      const rank = Number(square[1]);             // 1..8
      const row = 8 - rank;                       // rank8 -> 0
      return b[row][file];
    }

    const w_d4 = at("d4"), w_c4 = at("c4");
    const bl_d5 = at("d5"), bl_e6 = at("e6");

    const n_c3 = at("c3"), n_f3 = at("f3");

    const okPawns =
      w_d4 && w_d4.color==="w" && w_d4.type==="p" &&
      w_c4 && w_c4.color==="w" && w_c4.type==="p" &&
      bl_d5 && bl_d5.color==="b" && bl_d5.type==="p" &&
      bl_e6 && bl_e6.color==="b" && bl_e6.type==="p";

    const okKnight =
      (n_c3 && n_c3.color==="w" && n_c3.type==="n") ||
      (n_f3 && n_f3.color==="w" && n_f3.type==="n");

    return okPawns && okKnight;
  }

  function tryUnlock() {
    if (unlocked) return;
    if (isQueensGambitSetup()) {
      unlocked = true;
      $("flagText").textContent = FLAG;
      $("flagBox").style.display = "block";
      // freeze board after unlock (optional)
      syncUI();
    }
  }

  function syncUI() {
    $("fenText").textContent = game.fen();
    const pgn = game.pgn({ newline_char: "\n" }).trim();
    $("pgnText").textContent = pgn.length ? pgn : "(none yet)";

    cg.set({
      fen: game.fen(),
      turnColor: game.turn() === "w" ? "white" : "black",
      movable: {
        color: (!unlocked && game.turn() === "w") ? "white" : null,
        dests: (!unlocked && game.turn() === "w") ? calcDests() : new Map(),
      },
      lastMove: lastMoveSquares(),
      check: game.in_check() ? (game.turn() === "w" ? "white" : "black") : false,
    });

    tryUnlock();
  }

  function playBlack() {
    if (unlocked) return;
    if (game.turn() !== "b" || game.game_over()) return;

    const reply = OPENING_BOOK.get(game.fen()) || chooseFallbackMove();
    if (reply) game.move(reply);
    syncUI();
  }

  const cg = Chessground($("board"), {
    orientation: "white",
    coordinates: true,
    animation: { enabled: true, duration: 160 },
    highlight: { lastMove: true, check: true },
    draggable: { enabled: true },
    movable: {
      color: "white",
      free: false,
      dests: calcDests(),
      events: {
        after: (orig, dest) => {
          if (unlocked) return;
          if (game.turn() !== "w") return;

          const candidates = game.moves({ verbose: true });
          const ok = candidates.find(m => m.from === orig && m.to === dest);
          if (!ok) return;

          game.move({ from: orig, to: dest, promotion: "q" }); // auto-queen
          syncUI();
          setTimeout(playBlack, 200);
        }
      }
    }
  });

  $("newBtn").addEventListener("click", () => {
    game.reset();
    unlocked = false;
    $("flagBox").style.display = "none";
    syncUI();
  });

  $("flipBtn").addEventListener("click", () => {
    flipped = !flipped;
    cg.set({ orientation: flipped ? "black" : "white" });
  });

  $("undoBtn").addEventListener("click", () => {
    if (unlocked) return;
    game.undo(); // undo black
    game.undo(); // undo white
    syncUI();
  });

  $("copyFenBtn").addEventListener("click", async () => navigator.clipboard.writeText(game.fen()));
  $("copyPgnBtn").addEventListener("click", async () => navigator.clipboard.writeText(game.pgn()));

  syncUI();
});
</script>
</body>
</html>
