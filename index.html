<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Queens Gambit CTF</title>

  <!-- chessboard.js CSS -->
  <link rel="stylesheet"
        href="./assets/vendor/chessboardjs-1.0.0/css/chessboard-1.0.0.min.css">

  <style>
    /* Dark mode page + centered layout */
    body {
      margin: 0;
      min-height: 100vh;
      background: #0b0f14;
      color: #e6edf3;
      font-family: Arial, sans-serif;

      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;

      gap: 18px;
    }

    h1 {
      margin: 0;
      font-size: 48px;
      letter-spacing: 1px;
    }

    /* Bigger board */
    #board {
      width: 720px;      /* change to 800/900 if you want */
      max-width: 92vw;   /* responsive */
    }

    /* Card wrapper */
    .wrap {
      padding: 28px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.04);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    #status {
      margin-top: 14px;
      font-size: 18px;
      opacity: 0.9;
    }

    #flag {
      margin-top: 14px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(0, 255, 140, 0.12);
      border: 1px solid rgba(0, 255, 140, 0.35);
      font-family: monospace;
      font-size: 18px;
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Chess Board</h1>

    <!-- The board renders inside this div -->
    <div id="board"></div>

    <!-- Status + flag output -->
    <div id="status"></div>
    <div id="flag"></div>
  </div>

  <!-- ================== SCRIPTS (ORDER MATTERS) ================== -->

  <!-- 1) jQuery (required by chessboard.js) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- 2) chess.js (rules engine) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <!-- 3) chessboard.js (visual board + dragging) -->
  <script src="./assets/vendor/chessboardjs-1.0.0/js/chessboard-1.0.0.min.js"></script>

  <!-- 4) CTF logic -->
  <script>
    // =========================
    // CTF SETTINGS
    // =========================

    // Scripted solution path:
    // each step is White move (w) then Black reply (b)
    // Use UCI like "d2d4", "g1f3", etc.
    const SCRIPT = [
      { w: "d2d4", b: "d7d5" }, // 1. d4 d5
      { w: "c2c4", b: "e7e6" }, // 2. c4 e6 (Queen's Gambit Declined)
      { w: "b1c3", b: "g8f6" }, // 3. Nc3 Nf6
      // Add more steps here
    ];

    // Win condition: when a specific piece ends up on a specific square
    // piece values: wK,wQ,wR,wB,wN,wP and bK,bQ,bR,bB,bN,bP
    const WIN_CONDITION = { piece: "wQ", square: "e7" };

    // The flag to show
    const FLAG_TEXT = "BM{your_flag_goes_here}";

    // =========================
    // SETUP
    // =========================

    var game = new Chess();
    var step = 0;

    const statusEl = document.getElementById("status");
    const flagEl = document.getElementById("flag");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function showFlag() {
      flagEl.style.display = "block";
      flagEl.textContent = "FLAG: " + FLAG_TEXT;
      setStatus("Solved.");
    }

    function toUCI(from, to) {
      return from + to;
    }

    function makeMoveUCI(uci) {
      return game.move({
        from: uci.slice(0, 2),
        to: uci.slice(2, 4),
        promotion: "q"
      });
    }

    function isPieceOnSquare(pieceCode, square) {
      const sq = game.get(square); // {type:'p', color:'w'} or null
      if (!sq) return false;
      const actual = (sq.color + sq.type).toLowerCase(); // e.g. "wq"
      return actual === pieceCode.toLowerCase();
    }

    function checkWinCondition() {
      if (isPieceOnSquare(WIN_CONDITION.piece, WIN_CONDITION.square)) {
        showFlag();
      }
    }

    var board = Chessboard("board", {
      draggable: true,
      position: "start",
      pieceTheme: "./assets/vendor/chessboardjs-1.0.0/img/chesspieces/wikipedia/{piece}.png",

      onDragStart: function (source, piece) {
        // block moves after solved
        if (flagEl.style.display === "block") return false;

        // only allow white pieces to be moved
        if (piece.startsWith("b")) return false;

        // also prevent moving if it isn't white's turn in chess.js
        if (game.turn() !== "w") return false;
      },

      onDrop: function (source, target) {
        // no-op drop
        if (source === target) return "snapback";

        const expected = SCRIPT[step]?.w;
        if (!expected) {
          setStatus("No more scripted moves. Add more steps to SCRIPT.");
          return "snapback";
        }

        const uci = toUCI(source, target);

        // enforce the exact required move for the CTF path
        if (uci !== expected) {
          setStatus("Wrong move. Expected: " + expected);
          return "snapback";
        }

        // Apply white move
        const wMove = makeMoveUCI(uci);
        if (wMove === null) {
          setStatus("Illegal move.");
          return "snapback";
        }

        // update visuals
        board.position(game.fen());

        // check if white just triggered win
        checkWinCondition();
        if (flagEl.style.display === "block") return;

        // Apply black scripted reply
        const bUci = SCRIPT[step].b;
        const bMove = makeMoveUCI(bUci);
        if (bMove === null) {
          setStatus("Script error: black move illegal: " + bUci);
          return;
        }

        step++;

        // update visuals again
        board.position(game.fen());

        // check after black move too (optional)
        checkWinCondition();

        if (flagEl.style.display !== "block") {
          setStatus("Good. Step " + (step + 1) + " of " + SCRIPT.length + ". Next: " + (SCRIPT[step]?.w || "(end)"));
        }
      }
    });

    setStatus("Play the scripted line. Step 1: " + SCRIPT[0].w);
  </script>
</body>
</html>
