<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Queens Gambit CTF</title>

  <link rel="stylesheet" href="./assets/vendor/chessboardjs-1.0.0/css/chessboard-1.0.0.min.css">

  <style>
    body{
      margin:0;
      min-height:100vh;
      background:#0b0f14;
      color:#e6edf3;
      font-family:Arial,sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
    }
    h1{
      margin:0;
      font-size:48px;
      letter-spacing:1px;
    }
    #board{
      width:780px;
      max-width:92vw;
    }
    .wrap{
      padding:28px;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      width:fit-content;
    }
    #status{
      margin-top:14px;
      font-size:18px;
      opacity:.95;
      max-width:780px;
      line-height:1.35;
    }
    #successScreen{
      display:none;
      padding:28px;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      width:min(1000px,92vw);
      text-align:center;
      opacity:0;
      transform:translateY(8px);
      transition:opacity 250ms ease, transform 250ms ease;
    }
    #successScreen.show{
      opacity:1;
      transform:translateY(0);
    }
    #successScreen h2{
      margin:0 0 10px 0;
      font-size:42px;
      letter-spacing:1px;
    }
    #successScreen p{
      margin:0 0 18px 0;
      opacity:.9;
      font-size:18px;
    }
    #restartBtn{
      margin-top:18px;
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:#e6edf3;
      cursor:pointer;
      font-size:16px;
    }
    #restartBtn:hover{
      background:rgba(255,255,255,.10);
    }
  </style>
</head>

<body>
  <div class="wrap" id="gameScreen">
    <h1>Chess Board</h1>
    <div id="board"></div>
    <div id="status"></div>
  </div>

  <div id="successScreen">
    <h2>Well played.</h2>
    <p>You found the idea hiding in plain sight.</p>
    <p id="flagLine"></p>
    <div>
      <button id="restartBtn" type="button">Restart</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="./assets/vendor/chessboardjs-1.0.0/js/chessboard-1.0.0.min.js"></script>

  <script>
    const LINE=(function(){
      const _A=[[[128,171,15,234],[159,81,76,49]],[[172,200,44,73],[181,50,105,145]],[[117,83,105,208],[111,165,4,134]],[[177,220,72,56],[158,187,191,35]],[[175,39,220,204],[10,102,55,97]],[[94,156,188,185],[111,171,190,219]],[[77,178,222,171],[53,95,67,242]],[[191,216,30,190],[126,84,70,52]],[[16,17,127,14],[206,207,128,25]],[[36,105,151,106],[60,149,211,179]]];
      const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
      const _seed=(i,t)=>((0x00C0FFEE^(((i+1)*0x9E3779B9)>>>0)^(t?0xA5A5A5A5:0x5A5A5A5A))>>>0);
      const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
      return _A.map((p,i)=>({
        get w(){return _d(p[0],_seed(i,1))},
        get b(){return _d(p[1],_seed(i,0))}
      }));
    })();

    const QUEEN_TARGET_SQUARE=(function(){
      const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
      const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
      return _d([222,67],0x0BADF00D);
    })();

    const HINTS=(function(){
      const _H=[
        [220,179,199,118,250,96,129,30,1,214,186,84,226,196,28,111,225,29,116,32,119,189,166,168,197,43,61,94,44,19,70,229,4,35,44,61,82,49,105,101,29,57,167,252,214,195,125,147,62,15],
        [201,166,243,116,236,49,196,22,76,203,171,80,237,212,0,109,237,85,116,45,116,230,183,184,139,52,43,80,101,29,82,166,92,59,114,41,71,59,102,112,29,35,246,184,211,201,57,212,44,65,7,149,201,10,59,87,114,116,34,146,177,223,137,232,193,47,49,25],
        [216,191,218,102,245,45,196,30,79,214,186,69,176,221,31,45,232,1,104,48,34,189,166,234,205,99,56,29,36,78,92,252,91,34,52,56],
        [222,188,204,102,242,45,196,30,79,214,190,90,237,197,28,111,235,83,112,40,55,189,163,169,156,42,47,84,110,85,86,238,10,35,44,57,71,51,115,113,21,38,163,178],
        [203,160,199,118,250,96,129,30,11,202,188,86,224,193,11,41,233,83,120,61,116,236,182,173,143,99,43,92,112,25,88,243,30,50,98,38],
        [202,183,218,102,245,45,196,30,76,203,171,75,224,197,0,109,229,29,120,60,32,235,170,184,205,36,56,29,36,70,69,242,26,34,63,58,82,49,105,101,31],
        [209,169,245,112,236,49,196,22,70,200,171,75,237,220,10,109,229,29,116,61,118,189,166,170,141,42,43,93,44,83,80,241,91,63,98,59,71,45,116,104],
        [216,191,218,102,245,45,196,30,72,203,171,75,224,197,0,109,237,85,116,45,116,230,187,186,141,46,61,95,44,86,82,238,0,35,44,61,82,49,105,101,29,57,167,252,214],
        [216,191,218,102,245,45,196,30,77,214,186,90,237,197,28,111,225,29,116,40,52,189,166,170,197,36,43,80,101,23,92,245,30,50,114,41,71,59,102,112,29,35,246,184,211,201,57,212,44,65],
        [209,169,245,112,236,49,196,22,75,203,171,75,224,197,0,109,237,85,116,45,116,230,187,186,141,46,61,95,44,84,70,229,4,35,44,61,82,49,105,101,31,57,167,252,214,195,125,147,62,15]
      ];
      const _S=[
        0x11111111,0x2468CDF0,0x37C069CF,0x4B17E5AE,0x5E6F618D,0x71C6DD6C,0x851E594B,0x9875D52A,0xABCD5109,0xBF24CCE8
      ];
      const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
      const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
      return new Proxy(_H,{get(t,p){if(p==="length")return t.length;const i=+p;return Number.isInteger(i)&&i>=0&&i<t.length?_d(t[i],_S[i]):undefined}});
    })();

    const WRONG_HINTS=(function(){
      const _W=[
        [207,167,243,116,236,49,196,22,76,203,171,75,237,197,28,111,225,29,116,45,116,230,187,186,141,46,61,95,44,19,70,229,4,35,44,57,71,51,115,113,21,38,163,178,144],
        [219,191,218,102,245,45,196,30,77,214,186,90,237,197,28,111,225,29,116,40,52,189,166,170,197,36,43,80,101,23,92,245,30,50,114,41,71,59,102,112,29,35,246],
        [222,188,204,102,242,45,196,30,79,214,186,90,237,197,28,111,225,29,116,40,52,189,166,170,197,43,61,94,44,83,80,241,91,63,98,59,71,45,116,104,31],
        [209,169,245,112,236,49,196,22,75,203,171,75,224,197,0,109,229,29,120,60,32,235,170,184,205,36,56,29,36,70,69,242,26,34,63,58,82,49,105,101,31,57,167,252,214,195,125,147,62,15]
      ];
      const _S=[0x22222222,0x2468ACE0,0x26AF37BE,0x28F5C29C];
      const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
      const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
      return new Proxy(_W,{get(t,p){if(p==="length")return t.length;const i=+p;return Number.isInteger(i)&&i>=0&&i<t.length?_d(t[i],_S[i]):undefined}});
    })();

    const gameScreen=document.getElementById("gameScreen");
    const successScreen=document.getElementById("successScreen");
    const restartBtn=document.getElementById("restartBtn");
    const statusEl=document.getElementById("status");
    const flagLine=document.getElementById("flagLine");

    function setStatus(msg){
      statusEl.textContent=msg;
    }

    function showSuccessScreen(){
      (function(){
        const _F=[209,46,57,92,51,108,52,202,214,194,85,145,191,119,32,16,35,238,24,234,244,198,192,53,36,37,47,215,67,166,137,240,52,158,183,14,235,211,190,123];
        const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
        const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
        flagLine.textContent=_d(_F,0xDEADBEEF);
      })();
      gameScreen.style.display="none";
      successScreen.style.display="block";
      requestAnimationFrame(() => successScreen.classList.add("show"));
    }

    function resetScreens(){
      successScreen.classList.remove("show");
      successScreen.style.display="none";
      gameScreen.style.display="block";
      flagLine.textContent="";
    }

    function uciToMoveObj(uci){
      return { from: uci.slice(0,2), to: uci.slice(2,4), promotion: "q" };
    }

    function isWhiteQueenOn(square){
      const sq = game.get(square);
      return !!sq && sq.color === "w" && sq.type === "q";
    }

    function wrongHint(i){
      return WRONG_HINTS[i % WRONG_HINTS.length];
    }

    var game, board;
    var step = 0;

    function syncBoard(){
      board.position(game.fen());
    }

    function updateHint(){
      (function(){
        const _M={
          p:[238,103,99,245,18,161,193,131,76,171,32,210,27,58],
          c:[219,170,217,118,245,45,196,30,79,214,186,90,237,197,28,111,225,29],
          s1:0x33333333,
          s2:0x34353637
        };
        const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
        const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
        const a=_d(_M.p,_M.s1);
        const b=HINTS[step] || _d(_M.c,_M.s2);
        setStatus(a + b);
      })();
    }

    function newGame(){
      game = new Chess();
      step = 0;
      resetScreens();

      if (board) {
        board.position("start");
      } else {
        board = Chessboard("board", {
          draggable: true,
          position: "start",
          pieceTheme: "./assets/vendor/chessboardjs-1.0.0/img/chesspieces/wikipedia/{piece}.png",
          onDragStart: function(source, piece){
            if (piece.startsWith("b")) return false;
            if (game.turn() !== "w") return false;
            if (successScreen.style.display === "block") return false;
          },
          onDrop: function(source, target){
            if (source === target) return "snapback";

            const expected = LINE[step]?.w;
            if (!expected) {
              (function(){
                const _m=[238,103,99,245,18,161,193,131,76,171,32,210,27,58,250,233,153,197];
                const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
                const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
                setStatus(_d(_m,0x35363738));
              })();
              return "snapback";
            }

            const uci = source + target;
            if (uci !== expected) {
              setStatus(wrongHint(step));
              return "snapback";
            }

            const wMove = game.move(uciToMoveObj(uci));
            if (wMove === null) {
              (function(){
                const _m=[219,170,217,118,245,45,196,30,79,214,186,90,237,197,28,111,225,29,116,40,52,189];
                const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
                const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
                setStatus(_d(_m,0x36373839));
              })();
              return "snapback";
            }

            syncBoard();

            if (isWhiteQueenOn(QUEEN_TARGET_SQUARE)) {
              showSuccessScreen();
              return;
            }

            const bUci = LINE[step].b;
            const bMove = game.move(uciToMoveObj(bUci));
            if (bMove === null) {
              (function(){
                const _m=[207,167,243,116,236,49,196,22,76,203,171,75,237,197,0,109,229,29,120,60];
                const _x=s=>{s|=0;s^=s<<13;s^=s>>>17;s^=s<<5;return s>>>0};
                const _d=(arr,seed)=>{let s=seed>>>0,o="";for(let i=0;i<arr.length;i++){s=_x(s);o+=String.fromCharCode((arr[i]^(s&255))&255)}return o};
                setStatus(_d(_m,0x3738393A));
              })();
              return;
            }

            step++;
            syncBoard();

            if (isWhiteQueenOn(QUEEN_TARGET_SQUARE)) {
              showSuccessScreen();
              return;
            }

            updateHint();
          }
        });
      }

      updateHint();
    }

    restartBtn.addEventListener("click", newGame);
    newGame();
  </script>
</body>
</html>
